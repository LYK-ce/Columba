# columba 设计探索

## columba是什么
columba是一个任务运行agent，将用户的自然语言转换成服务器上各类具体的任务。我们将通过邮箱的方式实现与columba agent之间的沟通。columba将在后台运行一个邮箱进程，当收到用户的指令邮件之后，columba agent将会被唤醒，然后将邮件中用户的自然语言指令，转换成一系列服务器上的具体指令，例如运行某些训练任务，读取文件将结果通过邮件返回给用户等等。

## Scheduler_Daemon 设计探索

### 模块用途

Scheduler_Daemon 是 Columba 系统的**后台守护进程**，负责持续运行并管理系统的时间调度与事件触发。它是连接用户（通过邮件）与 Agent（执行任务）之间的桥梁，确保任务在正确的时间被触发执行。

### 核心功能

| 功能 | 优先级 | 说明 |
|------|--------|------|
| **定时器管理** | ⭐必须 | tick循环机制，按设定间隔检查并触发到期事件 |
| **邮箱接收** | ⭐必须 | IMAP/POP3 协议 poll 新邮件，检测用户指令 |
| **任务队列维护** | ⭐必须 | 队列 CRUD 操作 + 持久化存储，管理待执行任务 |
| **优雅关闭** | ⭐必须 | 捕获 SIGTERM/SIGINT 信号，安全退出并保存状态 |
| **状态持久化** | ⭐必须 | 重启后恢复队列状态，确保任务不丢失 |
| **PID文件管理** | 推荐 | 防止重复启动，便于进程管理 |
| **配置热加载** | 可选 | 修改配置无需重启守护进程 |

### 工作流程

```
┌─────────────────────────────────────────┐
│           Scheduler_Daemon              │
│                                         │
│   ┌─────────┐      ┌──────────────┐    │
│   │ 定时器   │ tick │  检查邮箱    │    │
│   │ (30s)   │─────→│  (IMAP poll) │    │
│   └─────────┘      └──────┬───────┘    │
│        │                  │            │
│        │           有新邮件?           │
│        │                  │            │
│        ▼                  ▼            │
│   ┌──────────────────────────────┐     │
│   │        任务队列               │     │
│   │  (检查到期任务 + 新任务入队)  │     │
│   └──────────────┬───────────────┘     │
│                  │                     │
│           有任务需执行?                │
│                  │                     │
│                  ▼                     │
│           【唤醒 Agent】               │
└─────────────────────────────────────────┘
```

## Agent 设计探索

### 模块用途

Agent 是 Columba 系统的**智能核心**，负责理解用户的自然语言指令并执行具体操作。Agent 基于 llama.cpp 运行本地 LLM，在 CPU 上进行推理，将人类语言转换为 API 调用。

### 核心职责

| 职责 | 说明 |
|------|------|
| **理解任务** | 解析自然语言指令，理解用户意图 |
| **调用API** | 执行具体操作（文件读写、命令执行、邮件发送等） |
| **生成新任务** | 若用户需要定时/周期执行，生成任务入队 |
| **结果返回** | 将执行结果通过邮件返回给用户 |

### 工作模式

Agent 采用**按需唤醒**模式，由 Scheduler_Daemon 在以下情况触发：
1. 收到用户新邮件
2. 队列中有到期任务

```
┌─────────────────────────────────────────────────────┐
│                    Agent 执行流程                    │
│                                                     │
│   【被唤醒】                                         │
│       │                                             │
│       ▼                                             │
│   ┌─────────────┐                                   │
│   │ LLM 推理    │ ← 理解任务内容                     │
│   │ (llama.cpp) │                                   │
│   └──────┬──────┘                                   │
│          │                                          │
│          ▼                                          │
│   ┌─────────────┐                                   │
│   │ 调用 API    │ ← 执行具体操作                     │
│   │ (执行任务)  │                                   │
│   └──────┬──────┘                                   │
│          │                                          │
│          ├──→ 需要定时执行? ──→ 生成任务入队         │
│          │                                          │
│          ▼                                          │
│   ┌─────────────┐                                   │
│   │ 返回结果    │ ← 邮件通知用户                     │
│   └─────────────┘                                   │
└─────────────────────────────────────────────────────┘
```

### 任务队列结构

Agent 生成的任务将存入 Scheduler_Daemon 管理的队列中：

```python
{
    "task_id": "uuid",
    "type": "immediate" | "scheduled" | "recurring",
    "trigger_at": "timestamp",       # 触发时间
    "interval": 300,                 # 循环间隔（秒）
    "prompt": "用户的自然语言指令",   # Agent理解后执行
    "user_email": "user@example.com"
}
```

### 设计优点

- **简单统一**：所有任务都由 Agent 理解和执行
- **智能处理**：每次执行都有上下文理解能力
- **错误恢复**：可智能理解错误信息并尝试调整

### 任务序列方案（待实现）

当用户下达包含多个步骤的复合任务时（如"创建文件夹并列出文件"），LLM 可一次性规划出任务序列，Agent 自动逐个执行。

#### 工作流程

```
用户请求: "创建Hello文件夹并列出当前文件"
         │
         ▼
┌─────────────────────────────────────────┐
│        LLM 任务规划                      │
│  输出任务序列（JSON数组格式）            │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│  [                                      │
│    {"tool": "Execute_Command",          │
│     "args": {"command": "mkdir Hello"}},│
│    {"tool": "Execute_Command",          │
│     "args": {"command": "dir"}}         │
│  ]                                      │
└────────────────┬────────────────────────┘
                 │
         ┌───────┴───────┐
         │  Agent 逐个   │
         │  执行任务序列  │
         └───────┬───────┘
                 │
    ┌────────────┼────────────┐
    ▼            ▼            ▼
 mkdir Hello    dir      汇总全部结果
    │            │            │
    └────────────┼────────────┘
                 ▼
┌─────────────────────────────────────────┐
│        LLM 结果总结                      │
│  综合所有执行结果，生成最终回复          │
└─────────────────────────────────────────┘
```

#### JSON格式规范

```python
# 单任务（当前已支持）
{"tool": "tool_name", "args": {"param": "value"}}

# 多任务序列（待实现）
[
    {"tool": "Execute_Command", "args": {"command": "mkdir Hello"}},
    {"tool": "Execute_Command", "args": {"command": "dir"}}
]
```

#### 实现改动点

| 组件 | 改动 |
|------|------|
| **System Prompt** | 新增任务序列格式说明，让LLM输出JSON数组 |
| **_Parse_Tool_Call()** | 支持解析JSON数组，返回任务列表 `List[tuple]` |
| **Run()** | 循环执行任务列表中的每个工具，汇总全部结果后发给LLM总结 |

#### 优点

1. **减少LLM调用次数**：一次规划，多次执行
2. **保证执行顺序**：按序列顺序逐个执行
3. **统一结果汇总**：所有结果一起返回给LLM生成最终回复

## API 模块设计探索

### 模块用途

API 模块是 Columba 系统的**能力层**，提供 Agent 可调用的具体操作能力。模块包含一个**统一调用入口（Gateway）**，负责安全校验后分发到具体 API 实现。

### 核心功能

| API | 说明 |
|-----|------|
| **file_read** | 文件读取 |
| **file_write** | 文件写入 |
| **shell_exec** | 命令执行 |
| **mail_send** | 邮件发送 |

### 架构设计

```
Agent
   │
   ▼
┌─────────────────────────────────────────┐
│         API Gateway (统一调用入口)       │
│  ┌────────────────────────────────────┐ │
│  │ 1. 权限校验：API是否在允许列表       │ │
│  │ 2. 参数校验：路径/命令是否安全       │ │
│  │ 3. 日志记录：审计追踪               │ │
│  └────────────────────────────────────┘ │
│                    │                    │
│         ┌─────────┼─────────┐          │
│         ▼         ▼         ▼          │
│   ┌─────────┐ ┌────────┐ ┌────────┐    │
│   │文件读写 │ │命令执行│ │邮件发送│    │
│   └─────────┘ └────────┘ └────────┘    │
└─────────────────────────────────────────┘
```

### Gateway 安全校验

| API | 校验项 |
|-----|--------|
| file_read | 路径白名单，禁止读取敏感文件 |
| file_write | 路径白名单，禁止覆盖系统文件 |
| shell_exec | 命令白名单/黑名单，禁止危险命令 |
| mail_send | 收件人白名单（可选） |

### 设计优点

- **安全可控**：统一入口进行权限校验，防止越权操作
- **易于扩展**：新增 API 只需实现具体功能并注册到 Gateway
- **审计追踪**：所有调用经过 Gateway，便于日志记录

## Log 模块设计探索

### 模块用途

Log 模块是 Columba 系统的**全局日志组件**，为所有模块提供统一的日志记录能力。作为基础设施模块，被 Scheduler_Daemon、Agent、API 等模块共同依赖。

### 核心功能

| 功能 | 说明 |
|------|------|
| **日志级别** | DEBUG、INFO、WARNING、ERROR、CRITICAL |
| **日志输出** | 文件输出 + 控制台输出（可配置） |
| **日志格式** | 时间戳、模块名、级别、消息内容 |
| **日志轮转** | 按大小或时间自动轮转，防止日志文件过大 |

### 使用方式

各模块通过统一接口记录日志：

```python
from Log import logger

# 各模块使用
logger.info("Scheduler_Daemon", "守护进程启动")
logger.debug("Agent", "LLM推理开始")
logger.error("API", "文件读取失败: /path/to/file")
```

### 日志格式示例

```
[2026-01-19 14:05:30] [INFO] [Scheduler_Daemon] 守护进程启动
[2026-01-19 14:05:31] [INFO] [Scheduler_Daemon] 检查邮箱: 发现1封新邮件
[2026-01-19 14:05:32] [INFO] [Agent] 开始处理任务: task_001
[2026-01-19 14:05:35] [DEBUG] [Agent] LLM推理完成
[2026-01-19 14:05:36] [INFO] [API] 调用 shell_exec: python train.py
[2026-01-19 14:05:40] [INFO] [API] 调用 mail_send: 发送至 user@example.com
```

### 设计优点

- **统一管理**：所有模块使用同一日志接口，格式一致
- **问题追踪**：便于排查系统运行问题
- **审计记录**：保留操作历史，满足安全审计需求
